import imghdr
import os
import pytest
import sys

sys.path.append("src/main/python")
sys.path.append("../../main/python")
from results_chart import CSVRenderer
from results_chart import Color

# from results_chart import CSVRenderer
# from src.main.python.results_chart import Color

TEST_OUTPUT_DIR = "/build/test-output/results_charts_test_py/"
RESOURCES_DIR = "/src/test/resources/"
PROJECT_ROOT_DIR = os.path.abspath(os.path.join(os.path.dirname(__file__), "../../.."))

parameterization = [
    ("results1.csv",
     [[Color(name='g', saturation=1.0), Color(name='g', saturation=0.1)],
      [Color(name='b', saturation=0.0), Color(name='b', saturation=0.85)],
      [Color(name='b', saturation=0.0), Color(name='b', saturation=0.05)]]
     ),
    ("results2.csv",
     [[Color(name='b', saturation=1.0), Color(name='b', saturation=1.0)],
      [Color(name='b', saturation=0.0), Color(name='g', saturation=0.33)]]
     ),
    ("results3.csv",
     [[Color(name='b', saturation=0.5),
       Color(name='b', saturation=0.5),
       Color(name='b', saturation=0.5)],
      [Color(name='r', saturation=0.09),
       Color(name='r', saturation=0.05),
       Color(name='r', saturation=0.03)],
      [Color(name='b', saturation=0.5),
       Color(name='b', saturation=0.5),
       Color(name='b', saturation=0.5)]]
     ),
    ("results-full.csv",
     [[Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=0.45),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='r', saturation=0.01)],
      [Color(name='b', saturation=0.11),
       Color(name='g', saturation=0.13),
       Color(name='b', saturation=0.03),
       Color(name='g', saturation=0.24),
       Color(name='b', saturation=0.17),
       Color(name='b', saturation=0.34),
       Color(name='g', saturation=0.61),
       Color(name='g', saturation=0.52),
       Color(name='b', saturation=0.29),
       Color(name='r', saturation=0.01),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.01)],
      [Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.54),
       Color(name='g', saturation=0.92),
       Color(name='g', saturation=0.19),
       Color(name='b', saturation=0.01),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.84),
       Color(name='g', saturation=0.95),
       Color(name='b', saturation=0.01),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.01)],
      [Color(name='b', saturation=0.16),
       Color(name='g', saturation=0.35),
       Color(name='b', saturation=0.08),
       Color(name='g', saturation=0.21),
       Color(name='g', saturation=0.14),
       Color(name='g', saturation=0.39),
       Color(name='g', saturation=0.93),
       Color(name='g', saturation=0.52),
       Color(name='g', saturation=0.14),
       Color(name='r', saturation=0.01),
       Color(name='b', saturation=0.03),
       Color(name='b', saturation=0.03)],
      [Color(name='b', saturation=0.2),
       Color(name='b', saturation=0.16),
       Color(name='b', saturation=0.1),
       Color(name='g', saturation=0.2),
       Color(name='b', saturation=0.42),
       Color(name='g', saturation=0.58),
       Color(name='g', saturation=0.44),
       Color(name='r', saturation=0.1),
       Color(name='b', saturation=0.07),
       Color(name='r', saturation=0.3),
       Color(name='r', saturation=0.06),
       Color(name='b', saturation=0.07)],
      [Color(name='b', saturation=0.65),
       Color(name='b', saturation=0.09),
       Color(name='b', saturation=0.19),
       Color(name='g', saturation=0.36),
       Color(name='b', saturation=0.3),
       Color(name='b', saturation=0.64),
       Color(name='b', saturation=0.39),
       Color(name='r', saturation=0.15),
       Color(name='b', saturation=0.41),
       Color(name='g', saturation=0.2),
       Color(name='g', saturation=0.07),
       Color(name='b', saturation=0.06)],
      [Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0)],
      [Color(name='r', saturation=0.01),
       Color(name='b', saturation=0.16),
       Color(name='b', saturation=0.07),
       Color(name='g', saturation=0.0),
       Color(name='b', saturation=0.01),
       Color(name='b', saturation=0.06),
       Color(name='b', saturation=0.14),
       Color(name='b', saturation=0.05),
       Color(name='b', saturation=0.02),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.17)],
      [Color(name='r', saturation=0.02),
       Color(name='r', saturation=0.07),
       Color(name='g', saturation=0.07),
       Color(name='r', saturation=0.01),
       Color(name='b', saturation=0.29),
       Color(name='b', saturation=0.21),
       Color(name='b', saturation=0.27),
       Color(name='r', saturation=0.07),
       Color(name='b', saturation=0.42),
       Color(name='g', saturation=0.01),
       Color(name='g', saturation=0.15),
       Color(name='g', saturation=0.25)],
      [Color(name='r', saturation=0.12),
       Color(name='r', saturation=0.01),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.11),
       Color(name='g', saturation=0.21),
       Color(name='r', saturation=0.1),
       Color(name='r', saturation=0.05),
       Color(name='r', saturation=0.12),
       Color(name='g', saturation=0.01),
       Color(name='b', saturation=0.02),
       Color(name='g', saturation=0.04),
       Color(name='b', saturation=0.03)],
      [Color(name='r', saturation=0.13),
       Color(name='r', saturation=0.0),
       Color(name='r', saturation=0.0),
       Color(name='b', saturation=0.11),
       Color(name='r', saturation=0.0),
       Color(name='r', saturation=0.01),
       Color(name='r', saturation=0.0),
       Color(name='r', saturation=0.01),
       Color(name='r', saturation=0.02),
       Color(name='g', saturation=0.01),
       Color(name='b', saturation=0.01),
       Color(name='g', saturation=0.0)],
      [Color(name='r', saturation=0.08),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='g', saturation=0.16),
       Color(name='r', saturation=0.01),
       Color(name='r', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='r', saturation=0.01),
       Color(name='g', saturation=0.0),
       Color(name='b', saturation=0.02),
       Color(name='g', saturation=0.03)],
      [Color(name='b', saturation=0.15),
       Color(name='b', saturation=0.49),
       Color(name='b', saturation=0.18),
       Color(name='b', saturation=0.39),
       Color(name='b', saturation=0.27),
       Color(name='b', saturation=0.27),
       Color(name='b', saturation=0.11),
       Color(name='g', saturation=0.07),
       Color(name='b', saturation=0.3),
       Color(name='b', saturation=0.12),
       Color(name='r', saturation=0.53),
       Color(name='g', saturation=0.1)],
      [Color(name='b', saturation=0.02),
       Color(name='b', saturation=0.03),
       Color(name='b', saturation=0.13),
       Color(name='b', saturation=0.01),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.12),
       Color(name='b', saturation=0.06),
       Color(name='b', saturation=0.05),
       Color(name='r', saturation=0.07),
       Color(name='b', saturation=0.04),
       Color(name='r', saturation=0.03),
       Color(name='r', saturation=0.02)],
      [Color(name='b', saturation=0.1),
       Color(name='r', saturation=0.05),
       Color(name='g', saturation=0.01),
       Color(name='b', saturation=0.0),
       Color(name='r', saturation=0.01),
       Color(name='b', saturation=0.11),
       Color(name='g', saturation=0.11),
       Color(name='g', saturation=0.08),
       Color(name='r', saturation=0.01),
       Color(name='b', saturation=0.01),
       Color(name='r', saturation=0.03),
       Color(name='r', saturation=0.02)],
      [Color(name='r', saturation=0.22),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='r', saturation=0.09),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='b', saturation=0.19),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='g', saturation=0.0)],
      [Color(name='r', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='r', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='g', saturation=0.0)],
      [Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.01),
       Color(name='g', saturation=0.01),
       Color(name='g', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='r', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='b', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0)],
      [Color(name='r', saturation=0.35),
       Color(name='r', saturation=0.49),
       Color(name='r', saturation=0.24),
       Color(name='g', saturation=0.67),
       Color(name='r', saturation=0.33),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.32),
       Color(name='g', saturation=0.46),
       Color(name='g', saturation=0.5)],
      [Color(name='r', saturation=0.34),
       Color(name='r', saturation=0.24),
       Color(name='r', saturation=0.31),
       Color(name='g', saturation=0.69),
       Color(name='r', saturation=0.96),
       Color(name='r', saturation=0.76),
       Color(name='r', saturation=0.26),
       Color(name='r', saturation=0.13),
       Color(name='r', saturation=0.94),
       Color(name='r', saturation=0.32),
       Color(name='g', saturation=0.52),
       Color(name='g', saturation=0.57)],
      [Color(name='r', saturation=0.01),
       Color(name='b', saturation=0.03),
       Color(name='r', saturation=0.01),
       Color(name='g', saturation=1.0),
       Color(name='r', saturation=0.75),
       Color(name='r', saturation=0.46),
       Color(name='r', saturation=0.22),
       Color(name='r', saturation=0.0),
       Color(name='r', saturation=0.73),
       Color(name='g', saturation=0.1),
       Color(name='g', saturation=0.85),
       Color(name='g', saturation=0.9)],
      [Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.08)],
      [Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.11)],
      [Color(name='b', saturation=0.14),
       Color(name='r', saturation=0.1),
       Color(name='r', saturation=0.1),
       Color(name='r', saturation=0.09),
       Color(name='g', saturation=0.19),
       Color(name='g', saturation=0.21),
       Color(name='g', saturation=0.25),
       Color(name='r', saturation=0.06),
       Color(name='g', saturation=0.28),
       Color(name='r', saturation=0.11),
       Color(name='r', saturation=0.31),
       Color(name='g', saturation=0.0)],
      [Color(name='b', saturation=0.23),
       Color(name='r', saturation=0.21),
       Color(name='g', saturation=0.14),
       Color(name='g', saturation=0.26),
       Color(name='g', saturation=0.26),
       Color(name='g', saturation=0.42),
       Color(name='g', saturation=0.62),
       Color(name='g', saturation=0.43),
       Color(name='g', saturation=0.33),
       Color(name='r', saturation=0.27),
       Color(name='r', saturation=0.23),
       Color(name='r', saturation=0.11)],
      [Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=1.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0),
       Color(name='g', saturation=0.0)]]
     ),
]


@pytest.mark.parametrize("csv_filename, expected_color_rows", parameterization)
def test_get_colors(csv_filename, expected_color_rows):
    sut = CSVRenderer(filename(RESOURCES_DIR + csv_filename), "test_output.png")
    assert sut.get_color_rows() == expected_color_rows


@pytest.mark.parametrize("csv_filename", [param[0] for param in parameterization])
def test_render_png(csv_filename):
    png_file = filename(TEST_OUTPUT_DIR + os.path.basename(csv_filename).replace('.csv', '.png'))

    os.makedirs(os.path.dirname(png_file), exist_ok=True)
    if os.path.exists(png_file):
        os.remove(png_file)
    sut = CSVRenderer(filename(RESOURCES_DIR + csv_filename), png_file)

    sut.render_png()

    assert os.path.exists(png_file), f"Output file '{png_file}' does not exist"
    assert imghdr.what(png_file) == "png", f"Output file '{png_file}' is not a valid PNG file"


def filename(relative_filename):
    return PROJECT_ROOT_DIR + relative_filename
